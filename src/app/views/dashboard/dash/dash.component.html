<div class="dashboard-container">
  <!-- Filter Panel Backdrop (click to close) -->
  <div class="filter-panel-backdrop" [class.active]="isFilterPanelOpen" (click)="toggleFilterPanel()"></div>

  <!-- Filter Panel -->
  <div class="filter-panel" [class.open]="isFilterPanelOpen">
    <div class="filter-header">
      <h3>Filters</h3>
      <div class="filter-header-actions">
        <button class="reset-btn" (click)="resetFilters()" title="Reset All Filters">
          <span>↻</span> Reset
        </button>
        <button class="close-filter-btn" (click)="toggleFilterPanel()" title="Close Filters (Press Escape)">
          <span>✕</span>
        </button>
      </div>
    </div>

    <div class="filter-content">
      <!-- Search Filter -->
      <div class="filter-section">
        <label class="filter-label">Search</label>
        <div class="search-input-container">
          <input type="text" 
                 class="search-input"
                 placeholder="Search nodes..."
                 [(ngModel)]="filters.searchTerm"
                 (input)="onSearchTermChange()">
          <button class="clear-search-btn" 
                  *ngIf="filters.searchTerm"
                  (click)="clearSearch()"
                  title="Clear search">
            ✕
          </button>
        </div>
      </div>

      <!-- Node Types Filter -->
      <div class="filter-section">
        <label class="filter-label">Node Types</label>
        <div class="checkbox-group">
          <label class="checkbox-item">
            <input type="checkbox" 
                   [checked]="filters.nodeTypes.task"
                   (change)="onNodeTypeFilterChange('task')">
            <span class="checkbox-text">
              Tasks ({{ getNodeTypeCount('task') }})
              <small *ngIf="getFilteredNodeTypeCount('task') !== getNodeTypeCount('task')">
                - {{ getFilteredNodeTypeCount('task') }} shown
              </small>
            </span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" 
                   [checked]="filters.nodeTypes.user"
                   (change)="onNodeTypeFilterChange('user')">
            <span class="checkbox-text">
              Users ({{ getNodeTypeCount('user') }})
              <small *ngIf="getFilteredNodeTypeCount('user') !== getNodeTypeCount('user')">
                - {{ getFilteredNodeTypeCount('user') }} shown
              </small>
            </span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" 
                   [checked]="filters.nodeTypes.group"
                   (change)="onNodeTypeFilterChange('group')">
            <span class="checkbox-text">
              Groups ({{ getNodeTypeCount('group') }})
              <small *ngIf="getFilteredNodeTypeCount('group') !== getNodeTypeCount('group')">
                - {{ getFilteredNodeTypeCount('group') }} shown
              </small>
            </span>
          </label>
        </div>
      </div>

      <!-- Task Status Filter -->
      <div class="filter-section" *ngIf="filters.nodeTypes.task">
        <label class="filter-label">Task Status</label>
        <div class="checkbox-group">
          <label class="checkbox-item">
            <input type="checkbox" 
                   [checked]="filters.taskStatus.all"
                   (change)="onTaskStatusFilterChange('all')">
            <span class="checkbox-text">All Statuses</span>
          </label>
          <label class="checkbox-item" *ngFor="let status of TASK_STATUSES">
            <input type="checkbox" 
                   [checked]="isTaskStatusActive(status)"
                   (change)="onTaskStatusFilterChange(status)">
            <span class="checkbox-text">{{ status | titlecase }}</span>
          </label>
        </div>
      </div>

      <!-- Assignment Status Filter -->
      <div class="filter-section" *ngIf="filters.nodeTypes.task">
        <label class="filter-label">Assignment Status</label>
        <div class="checkbox-group">
          <label class="checkbox-item">
            <input type="checkbox" 
                   [checked]="filters.assignmentStatus.all"
                   (change)="onAssignmentStatusFilterChange('all')">
            <span class="checkbox-text">All Tasks</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" 
                   [checked]="isAssignmentStatusActive('assigned')"
                   (change)="onAssignmentStatusFilterChange('assigned')">
            <span class="checkbox-text">Assigned</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" 
                   [checked]="isAssignmentStatusActive('unassigned')"
                   (change)="onAssignmentStatusFilterChange('unassigned')">
            <span class="checkbox-text">Unassigned</span>
          </label>
        </div>
      </div>

      <!-- Date Range Filter -->
      <div class="filter-section" *ngIf="filters.nodeTypes.task">
        <label class="filter-label">Date Range</label>
        <div class="date-inputs">
          <input type="date" 
                 class="date-input"
                 placeholder="Start Date"
                 [(ngModel)]="filters.dateRange.startDate"
                 (change)="onDateRangeChange()">
          <input type="date" 
                 class="date-input"
                 placeholder="End Date"
                 [(ngModel)]="filters.dateRange.endDate"
                 (change)="onDateRangeChange()">
        </div>
      </div>

      <!-- User Status Filter -->
      <div class="filter-section" *ngIf="filters.nodeTypes.user">
        <label class="filter-label">User Status</label>
        <div class="checkbox-group">
          <label class="checkbox-item">
            <input type="checkbox" 
                   [checked]="filters.userStatus.all"
                   (change)="onUserStatusFilterChange('all')">
            <span class="checkbox-text">All Users</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" 
                   [checked]="isUserStatusActive('active')"
                   (change)="onUserStatusFilterChange('active')">
            <span class="checkbox-text">Active</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" 
                   [checked]="isUserStatusActive('inactive')"
                   (change)="onUserStatusFilterChange('inactive')">
            <span class="checkbox-text">Inactive</span>
          </label>
        </div>
      </div>

      <!-- Group Status Filter -->
      <div class="filter-section" *ngIf="filters.nodeTypes.group">
        <label class="filter-label">Group Status</label>
        <div class="checkbox-group">
          <label class="checkbox-item">
            <input type="checkbox" 
                   [checked]="filters.groupStatus.all"
                   (change)="onGroupStatusFilterChange('all')">
            <span class="checkbox-text">All Groups</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" 
                   [checked]="isGroupStatusActive('active')"
                   (change)="onGroupStatusFilterChange('active')">
            <span class="checkbox-text">Active</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" 
                   [checked]="isGroupStatusActive('inactive')"
                   (change)="onGroupStatusFilterChange('inactive')">
            <span class="checkbox-text">Inactive</span>
          </label>
        </div>
      </div>

      <!-- Quick Filter Shortcuts -->
      <div class="filter-section">
        <label class="filter-label">Quick Filters</label>
        <div class="quick-filters">
          <button class="quick-filter-btn" (click)="quickFilterTasksOnly()">
            Tasks Only
          </button>
          <button class="quick-filter-btn" (click)="quickFilterUsersOnly()">
            Users Only
          </button>
          <button class="quick-filter-btn" (click)="quickFilterGroupsOnly()">
            Groups Only
          </button>
          <button class="quick-filter-btn" (click)="quickFilterUnassignedTasks()">
            Unassigned Tasks
          </button>
        </div>
      </div>

      <!-- Results Summary -->
      <div class="filter-summary">
        <div class="summary-item">
          <strong>Showing {{ filteredNodes.length }} of {{ allNodes.length }} nodes</strong>
        </div>
        <div class="summary-breakdown" *ngIf="filteredNodes.length !== allNodes.length">
          <span class="breakdown-item" *ngIf="getFilteredNodeTypeCount('task') > 0">
            {{ getFilteredNodeTypeCount('task') }} tasks
          </span>
          <span class="breakdown-item" *ngIf="getFilteredNodeTypeCount('user') > 0">
            {{ getFilteredNodeTypeCount('user') }} users
          </span>
          <span class="breakdown-item" *ngIf="getFilteredNodeTypeCount('group') > 0">
            {{ getFilteredNodeTypeCount('group') }} groups
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Drag Operation Message -->
  <div class="drag-message" *ngIf="isDragging && dragMessage" 
       [class.assign]="dragOperation === 'assign'"
       [class.unassign]="dragOperation === 'unassign'">
    <div class="drag-message-icon">
      <span *ngIf="dragOperation === 'assign'">✓</span>
      <span *ngIf="dragOperation === 'unassign'">✕</span>
    </div>
    <span>{{ dragMessage }}</span>
  </div>

  <div class="graph-canvas-container" 
       [class.panel-open]="isPanelOpen"
       [class.filter-panel-open]="isFilterPanelOpen">
    <canvas #graphCanvas 
            [class.dragging]="isDragging"
            [class.drag-over]="dropTargetNode !== null"></canvas>
  </div>
  
  <!-- Panel Backdrop (click to close) -->
  <div class="panel-backdrop" [class.active]="isPanelOpen" (click)="closePanel()"></div>
  
  <!-- Side Panel -->
  <div class="side-panel" [class.open]="isPanelOpen">    
    <div class="panel-header">
      <h3>Node Details</h3>
      <button class="close-btn" (click)="closePanel()" title="Close Panel (Press Escape)">
        <span>✕</span>
      </button>
    </div>
    
    <div class="panel-content">
      <!-- Loading Skeleton -->
      <div class="skeleton-loader" *ngIf="isLoadingPanelData">
        <div class="skeleton-item">
          <div class="skeleton-avatar"></div>
          <div class="skeleton-text">
            <div class="skeleton-line"></div>
            <div class="skeleton-line short"></div>
          </div>
        </div>
        <div class="skeleton-details">
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line short"></div>
          <div class="skeleton-line"></div>
        </div>
      </div>
      
      <!-- Node Details -->
      <div class="node-details" *ngIf="!isLoadingPanelData && selectedNodeDetails">
        <div class="node-header">
          <div class="node-icon">{{ getNodeTypeIcon(selectedNodeDetails!.type) }}</div>
          <div class="node-info">
            <h4>{{ selectedNodeDetails!.label }}</h4>
            <span class="node-type">{{ selectedNodeDetails!.type.toUpperCase() }}</span>
          </div>
          <div class="node-status" [style.background-color]="getNodeStatusColor(selectedNodeDetails!)"></div>
        </div>
        
        <div class="node-properties">
          <div class="property" *ngFor="let prop of getNodeDetails(selectedNodeDetails!) | keyvalue">
            <label>{{ prop.key }}:</label>
            <span>{{ prop.value }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
