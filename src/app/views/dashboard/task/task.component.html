<c-col xs="12">
  <c-card class="mb-4">
    <c-card-header class="d-flex justify-content-between align-items-center">
      <strong>Task Management</strong>
      <button 
        cButton 
        color="success"
        size="sm"
        (click)="openCreateModal()"
        [disabled]="isLoading"
        class="d-flex align-items-center"
      >
        <svg [cIcon]="icons.cilTask" size="sm" class="me-1" style="color:#fff"></svg>
        Create Task
      </button>
    </c-card-header>
    <c-card-body>
      <!-- Loading Spinner -->
      <div *ngIf="isLoading" class="loading-container">
        <div class="spinner-wrapper">
          <c-spinner color="danger" variant="grow"></c-spinner>
          <p class="loading-text">Loading tasks...</p>
        </div>
      </div>

      <div *ngIf="!isLoading">
        <!-- Search and Items per page controls -->
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
          <div class="d-flex align-items-center gap-2">
            <label class="me-2 mb-0">Items per page:</label>
            <div style="min-width: 90px;">
              <select 
                class="form-select form-select-sm"
                [value]="itemsPerPage"
                (change)="onItemsPerPageChange($event)"
                style="width: 100%;"
              >
                <option *ngFor="let option of itemsPerPageOptions" [value]="option">
                  {{ option }}
                </option>
              </select>
            </div>
          </div>
          <div class="search-container">
            <input 
              type="text" 
              class="form-control" 
              placeholder="Search tasks..." 
              [value]="searchTerm"
              (input)="onSearch($event)"
              style="width: 250px;"
            >
          </div>
        </div>

        <!-- Table -->
        <div class="table-responsive">
          <table cTable [hover]="true" [striped]="true" class="table">
            <thead>
              <tr>
                <th>#</th>
                <th>
                  <div class="d-inline">
                    Name
                    <svg [cIcon]="icons.cilTask" size="sm" class="ms-1 text-danger"></svg>
                  </div>
                </th>
                <th>
                  <div class="d-inline">
                    Status
                    <svg [cIcon]="icons.cilCheckCircle" size="sm" class="ms-1 text-danger"></svg>
                  </div>
                </th>
                <th>
                  <div class="d-inline">
                    Start Date
                    <svg [cIcon]="icons.cilCalendar" size="sm" class="ms-1 text-danger"></svg>
                  </div>
                </th>
                <th>
                  <div class="d-inline">
                    Due Date
                    <svg [cIcon]="icons.cilClock" size="sm" class="ms-1 text-danger"></svg>
                  </div>
                </th>
                <th>
                  <div class="d-inline">
                    Assigned By
                    <svg [cIcon]="icons.cilUserFollow" size="sm" class="ms-1 text-danger"></svg>
                  </div>
                </th>
                <th>
                  <div class="d-inline">
                    Created By
                    <svg [cIcon]="icons.cilUserPlus" size="sm" class="ms-1 text-danger"></svg>
                  </div>
                </th>
                <th>
                  <div class="d-inline">
                    Validated
                    <svg [cIcon]="icons.cilShieldAlt" size="sm" class="ms-1 text-danger"></svg>
                    <small *ngIf="isAdmin()" class="text-muted ms-1">(clickable)</small>
                  </div>
                </th>
                <th>
                  <div class="d-inline">
                    Admin Complete
                    <svg [cIcon]="icons.cilBadge" size="sm" class="ms-1 text-danger"></svg>
                  </div>
                </th>
                <th>
                  <div class="d-inline">
                    Actions
                    <svg [cIcon]="icons.cilSettings" size="sm" class="ms-1 text-danger"></svg>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let task of paginatedTasks; let i = index">
                <th scope="row">{{ (currentPage - 1) * itemsPerPage + i + 1 }}</th>
                <td>{{ task.name }}</td>
                <td>
                  <c-badge [color]="getStatusBadgeColor(task.status!)">
                    {{ task.status }}
                  </c-badge>
                </td>
                <td>{{ formatDate(task.startAt!) }}</td>
                <td>{{ formatDate(task.dueAt!) }}</td>
                <td>{{ userNames[task.assignedById!] || task.assignedById }}</td>
                <td>{{ userNames[task.createdById!] || task.createdById }}</td>
                <td>
                  <c-badge 
                    [color]="task.isValidated ? 'success' : 'danger'"
                    [ngClass]="{'clickable-badge': isAdmin()}"
                    [style.cursor]="isAdmin() ? 'pointer' : 'default'"
                    [title]="isAdmin() ? 'Click to toggle validation status' : ''"
                    (click)="isAdmin() ? toggleValidation(task) : null"
                  >
                    {{ task.isValidated ? 'Yes' : 'No' }}
                  </c-badge>
                </td>
                <td>
                  <div class="d-flex align-items-center gap-2 flex-wrap">
                    <c-badge [color]="task.adminComplete ? 'success' : 'danger'">
                      {{ task.adminComplete ? 'Complete' : 'Not complete' }}
                    </c-badge>
                    <ng-container *ngIf="isAdmin()">
                      <button cButton size="sm" color="success" variant="outline" (click)="markAdminComplete(task)" [disabled]="task.adminComplete">Complete</button>
                      <button cButton size="sm" color="danger" variant="outline" (click)="markAdminNotComplete(task)" [disabled]="!task.adminComplete">Not Complete</button>
                    </ng-container>
                  </div>
                </td>
                <td>
                  <button cButton color="info" size="sm" class="me-1" (click)="openViewModal(task)">
                    <svg [cIcon]="icons.cilTask" size="sm" class="me-1"></svg> View
                  </button>
                  <button cButton color="dark" size="sm" class="me-1" (click)="openHistoryModal(task)">
                    <svg [cIcon]="icons.cilHistory" size="sm" class="me-1"></svg> History
                  </button>
                  <button cButton color="warning" size="sm" class="me-1" (click)="editTask(task)">
                    <svg [cIcon]="icons.cilPencil" size="sm" class="me-1"></svg> Edit
                  </button>
                  <button cButton color="success" size="sm" class="me-1" (click)="openUserModal(task)">
                    <svg [cIcon]="icons.cilUser" size="sm" class="me-1"></svg> Users
                  </button>
                  <button cButton color="secondary" size="sm" (click)="openGroupModal(task)">
                    <svg [cIcon]="icons.cilPeople" size="sm" class="me-1"></svg> Groups
                  </button>
                </td>
              </tr>
              <tr *ngIf="paginatedTasks.length === 0 && !isLoading">
                <td colspan="10" class="text-center">
                  {{ searchTerm ? 'No tasks found matching your search.' : 'No tasks found.' }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination and Info -->
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="pagination-info">
            Showing {{ startItem }} to {{ endItem }} of {{ totalItems }} entries
            <span *ngIf="searchTerm" class="text-muted">(filtered)</span>
          </div>
          
          <nav *ngIf="totalPages > 1">
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item" [class.disabled]="currentPage === 1">
                <button 
                  class="page-link" 
                  (click)="onPageChange(currentPage - 1)"
                  [disabled]="currentPage === 1"
                >
                  Previous
                </button>
              </li>
              

              <li 
                class="page-item" 
                *ngFor="let page of pages" 
                [class.active]="page === currentPage"
              >
                <button 
                  class="page-link" 
                  (click)="onPageChange(page)"
                >
                  {{ page }}
                </button>
              </li>
              
              <li class="page-item" [class.disabled]="currentPage === totalPages">
                <button 
                  class="page-link" 
                  (click)="onPageChange(currentPage + 1)"
                  [disabled]="currentPage === totalPages"
                >
                  Next
                </button>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </c-card-body>
  </c-card>
</c-col>

<!-- Create Task Modal -->
<c-modal 
  [(visible)]="showCreateModal" 
  backdrop="static"
  size="lg"
>
  <c-modal-header>
    <h4 cModalTitle>{{ isEditing ? 'Edit Task' : 'Create New Task' }}</h4>
    <button 
      cButtonClose 
      (click)="closeCreateModal()"
      aria-label="Close"
    ></button>
  </c-modal-header>
  
  <c-modal-body>
    <form cForm [formGroup]="createTaskForm" (ngSubmit)="createTask()">
      <c-row>
        <c-col md="12" class="mb-3">
          <label cFormLabel for="taskName">Task Name *</label>
          <input 
            cFormControl
            type="text"
            id="taskName"
            formControlName="name"
            placeholder="Enter task name"
            [class.is-invalid]="createTaskForm.get('name')?.invalid && createTaskForm.get('name')?.touched"
          >
          <div 
            class="invalid-feedback"
            *ngIf="createTaskForm.get('name')?.invalid && createTaskForm.get('name')?.touched"
          >
            Task name is required (minimum 3 characters)
          </div>
        </c-col>
        
        <c-col md="12" class="mb-3">
          <label cFormLabel for="taskDescription">Description</label>
          <textarea 
            cFormControl
            id="taskDescription"
            formControlName="description"
            rows="2"
            placeholder="Enter task description"
          ></textarea>
        </c-col>
        
        <c-col md="6" class="mb-3">
          <label cFormLabel for="startAt">Start Date</label>
          <input 
            cFormControl
            type="datetime-local"
            id="startAt"
            formControlName="startAt"
          >
          <div *ngIf="createTaskForm.get('startAt')?.invalid && createTaskForm.get('startAt')?.touched" class="text-danger mt-1">
            <small *ngIf="createTaskForm.get('startAt')?.errors?.['dateNotPast']">
              Start date cannot be in the past
            </small>
          </div>
        </c-col>
        
        <c-col md="6" class="mb-3">
          <label cFormLabel for="dueAt">Due Date</label>
          <input 
            cFormControl
            type="datetime-local"
            id="dueAt"
            formControlName="dueAt"
          >
          <div *ngIf="createTaskForm.get('dueAt')?.invalid && createTaskForm.get('dueAt')?.touched" class="text-danger mt-1">
            <small *ngIf="createTaskForm.get('dueAt')?.errors?.['dateNotPast']">
              Due date cannot be in the past
            </small>
            <small *ngIf="createTaskForm.get('dueAt')?.errors?.['dueDateAfterStartDate']">
              Due date must be after start date
            </small>
          </div>
        </c-col>
      </c-row>
      
      <div *ngIf="createErrorMessage" class="alert alert-danger" role="alert">
        {{ createErrorMessage }}
      </div>
    </form>
  </c-modal-body>
  
  <c-modal-footer>
    <button 
      cButton 
      color="danger" 
      size="sm"
      (click)="closeCreateModal()"
      [disabled]="isCreating"
    >
      Cancel
    </button>
    <button 
      cButton 
      color="success" 
      size="sm"
      (click)="createTask()"
      [disabled]="isCreating || createTaskForm.invalid"
      class="d-flex align-items-center"
    >
      <svg [cIcon]="icons.cilTask" size="sm" class="me-1" style="color:#fff"></svg>
      <c-spinner *ngIf="isCreating" size="sm" class="me-1"></c-spinner>
      {{ isCreating ? (isEditing ? 'Updating...' : 'Creating...') : (isEditing ? 'Update Task' : 'Create Task') }}
    </button>
  </c-modal-footer>
</c-modal>

<!-- Edit Task Modal (reuse Create Modal for editing) -->
<!-- Title and button text handled in create modal -->

<!-- User Assignment Modal -->
<c-modal [(visible)]="showUserModal" backdrop="static" size="lg">
  <c-modal-header>
    <h4 cModalTitle>Assign Users to Task</h4>
    <button cButtonClose (click)="closeUserModal()" aria-label="Close"></button>
  </c-modal-header>
  <c-modal-body>
    <div *ngIf="selectedTask">
      <p><strong>Task:</strong> {{ selectedTask.name }}</p>
      <hr>
      
      <!-- Currently Assigned Users -->
      <div class="mb-4" *ngIf="getAssignedUsers(selectedTask).length > 0">
        <h6><strong>Currently Assigned Users:</strong></h6>
        <div class="assigned-users-list">
          <div *ngFor="let user of getAssignedUsers(selectedTask)" 
               class="d-flex align-items-center justify-content-between assigned-user-item">
            <div class="d-flex align-items-center">
              <svg [cIcon]="icons.cilUser" size="sm" class="me-2 text-primary"></svg>
              <span>{{ user.username }} ({{ user.email }})</span>
            </div>
            <button 
              cButton 
              color="danger" 
              size="sm" 
              variant="outline"
              (click)="unassignUser(user.id)"
              [disabled]="isUpdatingAssignments"
              title="Remove user from task"
            >
              <svg [cIcon]="icons.cilX" size="sm"></svg>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Add New Users -->
      <div class="mb-3">
        <h6><strong>Add Users:</strong></h6>
        <label class="form-label">Select users to assign (Hold Ctrl to select multiple)</label>
        <select 
          class="form-select" 
          multiple 
          size="6" 
          (change)="onNewUserSelection($event)"
          style="min-height: 150px;"
        >
          <option *ngFor="let u of getUnassignedUsers(selectedTask)" [value]="u.id">
            {{ u.username }} ({{ u.email }})
          </option>
        </select>
        <small class="form-text text-muted mt-2">
          Only users not currently assigned to this task are shown above.
        </small>
      </div>
    </div>
  </c-modal-body>
  <c-modal-footer>
    <button cButton color="secondary" size="sm" (click)="closeUserModal()">Cancel</button>
    <button 
      cButton 
      color="primary" 
      size="sm" 
      (click)="assignSelectedUsers()"
      [disabled]="isUpdatingAssignments || !hasNewUsersSelected()"
    >
      <c-spinner *ngIf="isUpdatingAssignments" size="sm" class="me-1"></c-spinner>
      {{ isUpdatingAssignments ? 'Updating...' : 'Add Selected Users' }}
    </button>
  </c-modal-footer>
</c-modal>

<!-- Group Assignment Modal -->
<c-modal [(visible)]="showGroupModal" backdrop="static" size="lg">
  <c-modal-header>
    <h4 cModalTitle>Assign Groups to Task</h4>
    <button cButtonClose (click)="closeGroupModal()" aria-label="Close"></button>
  </c-modal-header>
  <c-modal-body>
    <div *ngIf="selectedTask">
      <p><strong>Task:</strong> {{ selectedTask.name }}</p>
      <hr>
      
      <!-- Currently Assigned Groups -->
      <div class="mb-4" *ngIf="getAssignedGroups(selectedTask).length > 0">
        <h6><strong>Currently Assigned Groups:</strong></h6>
        <div class="assigned-groups-list">
          <div *ngFor="let group of getAssignedGroups(selectedTask)" 
               class="d-flex align-items-center justify-content-between assigned-group-item">
            <div class="d-flex align-items-center">
              <svg [cIcon]="icons.cilPeople" size="sm" class="me-2 text-secondary"></svg>
              <span>{{ group.name }}</span>
            </div>
            <button 
              cButton 
              color="danger" 
              size="sm" 
              variant="outline"
              (click)="unassignGroup(group.id)"
              [disabled]="isUpdatingAssignments"
              title="Remove group from task"
            >
              <svg [cIcon]="icons.cilMinus" size="sm"></svg>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Add New Groups -->
      <div class="mb-3">
        <h6><strong>Add Groups:</strong></h6>
        <label class="form-label">Select groups to assign (Hold Ctrl to select multiple)</label>
        <select 
          class="form-select" 
          multiple 
          size="6" 
          (change)="onNewGroupSelection($event)"
          style="min-height: 150px;"
        >
          <option *ngFor="let g of getUnassignedGroups(selectedTask)" [value]="g.id">
            {{ g.name }}
          </option>
        </select>
        <small class="form-text text-muted mt-2">
          Only groups not currently assigned to this task are shown above.
        </small>
      </div>
    </div>
  </c-modal-body>
  <c-modal-footer>
    <button cButton color="secondary" size="sm" (click)="closeGroupModal()">Cancel</button>
    <button 
      cButton 
      color="primary" 
      size="sm" 
      (click)="assignSelectedGroups()"
      [disabled]="isUpdatingAssignments || !hasNewGroupsSelected()"
    >
      <c-spinner *ngIf="isUpdatingAssignments" size="sm" class="me-1"></c-spinner>
      {{ isUpdatingAssignments ? 'Updating...' : 'Add Selected Groups' }}
    </button>
  </c-modal-footer>
</c-modal>

<!-- View Task Modal -->
<c-modal [visible]="showViewModal" (visibleChange)="showViewModal = $event" backdrop="static" size="lg">
  <c-modal-header>
    <h4 cModalTitle>Task Details</h4>
    <button cButtonClose (click)="showViewModal=false" aria-label="Close"></button>
  </c-modal-header>
  <c-modal-body>
    <div *ngIf="selectedTask">
      <p><strong>Name:</strong> {{ selectedTask.name }}</p>
      <p><strong>Description:</strong> {{ selectedTask.description || 'No description provided' }}</p>
      <p><strong>Status:</strong> 
        <c-badge [color]="getStatusBadgeColor(selectedTask.status!)">
          {{ selectedTask.status }}
        </c-badge>
      </p>
      <p><strong>Start Date:</strong> {{ formatDate(selectedTask.startAt!) }}</p>
      <p><strong>Due Date:</strong> {{ formatDate(selectedTask.dueAt!) }}</p>
      <p><strong>Assigned By:</strong> {{ userNames[selectedTask.assignedById!] || 'Unknown' }}</p>
      <p><strong>Created By:</strong> {{ userNames[selectedTask.createdById!] || 'Unknown' }}</p>
      <p><strong>Validated:</strong> 
        <c-badge 
          [color]="selectedTask.isValidated ? 'success' : 'danger'"
          [ngClass]="{'clickable-badge': isAdmin()}"
          [style.cursor]="isAdmin() ? 'pointer' : 'default'"
          [title]="isAdmin() ? 'Click to toggle validation status' : ''"
          (click)="isAdmin() ? toggleValidation(selectedTask) : null"
        >
          {{ selectedTask.isValidated ? 'Yes' : 'No' }}
        </c-badge>
        <small *ngIf="isAdmin()" class="text-muted ms-2">(click to toggle)</small>
      </p>
      <p><strong>Admin Complete:</strong> 
        <c-badge [color]="selectedTask.adminComplete ? 'success' : 'danger'">
          {{ selectedTask.adminComplete ? 'Complete' : 'Not complete' }}
        </c-badge>
        <ng-container *ngIf="isAdmin()">
          <button cButton size="sm" color="success" variant="outline" class="ms-2" (click)="markAdminComplete(selectedTask)" [disabled]="selectedTask.adminComplete">Complete</button>
          <button cButton size="sm" color="danger" variant="outline" class="ms-1" (click)="markAdminNotComplete(selectedTask)" [disabled]="!selectedTask.adminComplete">Not Complete</button>
        </ng-container>
      </p>
      
      <hr />
      
      <!-- Assigned Users Display -->
      <div class="mb-3">
        <h6><strong>Assigned Users:</strong></h6>
        <div *ngIf="getAssignedUsers(selectedTask).length > 0; else noUsers" class="assigned-list">
          <div *ngFor="let user of getAssignedUsers(selectedTask)" class="d-flex align-items-center mb-2">
            <svg [cIcon]="icons.cilUser" size="sm" class="me-2 text-primary"></svg>
            <span>{{ user.username }} ({{ user.email }})</span>
          </div>
        </div>
        <ng-template #noUsers>
          <p class="text-muted mb-0">No users assigned to this task</p>
        </ng-template>
      </div>
      
      <!-- Assigned Groups Display -->
      <div class="mb-3">
        <h6><strong>Assigned Groups:</strong></h6>
        <div *ngIf="getAssignedGroups(selectedTask).length > 0; else noGroups" class="assigned-list">
          <div *ngFor="let group of getAssignedGroups(selectedTask)" class="d-flex align-items-center mb-2">
            <svg [cIcon]="icons.cilPeople" size="sm" class="me-2 text-secondary"></svg>
            <span>{{ group.name }}</span>
          </div>
        </div>
        <ng-template #noGroups>
          <p class="text-muted mb-0">No groups assigned to this task</p>
        </ng-template>
      </div>
    </div>
  </c-modal-body>
  <c-modal-footer>
    <button cButton color="info" size="sm" class="me-2" (click)="openHistoryModal(selectedTask!)">
      <svg [cIcon]="icons.cilHistory" size="sm" class="me-1"></svg> View History
    </button>
    <button cButton color="secondary" size="sm" (click)="showViewModal=false">Close</button>
  </c-modal-footer>
</c-modal>

<!-- Admin Not Complete Modal -->
<c-modal [(visible)]="showAdminNotCompleteModal" backdrop="static" size="sm">
  <c-modal-header>
    <h4 cModalTitle>Mark as Not Complete</h4>
    <button cButtonClose (click)="closeAdminNotCompleteModal()" aria-label="Close"></button>
  </c-modal-header>
  <c-modal-body>
    <p class="mb-2">Optionally include a message to the assigned users:</p>
    <textarea
      class="form-control"
      rows="3"
      [(ngModel)]="adminNotCompleteMessage"
      placeholder="Enter an optional message..."
    ></textarea>
  </c-modal-body>
  <c-modal-footer>
    <button cButton color="secondary" size="sm" (click)="closeAdminNotCompleteModal()" [disabled]="isSubmittingAdminNotComplete">Cancel</button>
    <button cButton color="danger" size="sm" (click)="confirmAdminNotComplete()" [disabled]="isSubmittingAdminNotComplete">
      <c-spinner *ngIf="isSubmittingAdminNotComplete" size="sm" class="me-1"></c-spinner>
      Confirm
    </button>
  </c-modal-footer>
</c-modal>

<!-- Toast Notifications -->
<p-toast></p-toast>
