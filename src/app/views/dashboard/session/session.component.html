<div class="dashboard-container">
  <!-- Drag Operation Message -->
  <div class="drag-message" *ngIf="isDragging && dragMessage" 
       [class.assign]="dragOperation === 'assign'"
       [class.unassign]="dragOperation === 'unassign'">
    <div class="drag-message-icon">
      <span *ngIf="dragOperation === 'assign'">✓</span>
      <span *ngIf="dragOperation === 'unassign'">✕</span>
    </div>
    <span>{{ dragMessage }}</span>
  </div>

  <div class="graph-canvas-container" [class.panel-open]="isPanelOpen">
    <canvas #graphCanvas 
            [class.dragging]="isDragging"
            [class.drag-over]="dropTargetNode !== null"></canvas>
  </div>
  
  <!-- Panel Backdrop (click to close) -->
  <div class="panel-backdrop" [class.active]="isPanelOpen" (click)="closePanel()"></div>
  
  <!-- Side Panel -->
  <div class="side-panel" [class.open]="isPanelOpen">    
    <div class="panel-header">
      <h3>Node Details</h3>
      <button class="close-btn" (click)="closePanel()" title="Close Panel (Press Escape)">
        <span>✕</span>
      </button>
    </div>
    
    <div class="panel-content">
      <!-- Loading Skeleton -->
      <div class="skeleton-loader" *ngIf="isLoadingPanelData">
        <div class="skeleton-item">
          <div class="skeleton-avatar"></div>
          <div class="skeleton-text">
            <div class="skeleton-line"></div>
            <div class="skeleton-line short"></div>
          </div>
        </div>
        <div class="skeleton-details">
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line short"></div>
          <div class="skeleton-line"></div>
        </div>
      </div>
      
      <!-- Node Details -->
      <div class="node-details" *ngIf="!isLoadingPanelData && selectedNodeDetails">
        <div class="node-header">
          <div class="node-icon">{{ getNodeTypeIcon(selectedNodeDetails!.type) }}</div>
          <div class="node-info">
            <h4>{{ selectedNodeDetails!.label }}</h4>
            <span class="node-type">{{ selectedNodeDetails!.type.toUpperCase() }}</span>
          </div>
          <div class="node-status" [style.background-color]="getNodeStatusColor(selectedNodeDetails!)"></div>
        </div>
        
        <div class="node-properties">
          <div class="property" *ngFor="let prop of getNodeDetails(selectedNodeDetails!) | keyvalue">
            <label>{{ prop.key }}:</label>
            <span *ngIf="prop.key !== 'Related Tasks'">{{ prop.value }}</span>
            <!-- Special handling for Related Tasks to display as a list -->
            <div *ngIf="prop.key === 'Related Tasks'" class="related-tasks">
              <div *ngIf="prop.value === 'Loading...'" class="loading">Loading...</div>
              <div *ngIf="prop.value === 'No validated tasks assigned'" class="no-tasks">No validated tasks assigned</div>
              <div *ngIf="splitRelatedTasks(prop.value).length > 0" class="task-list">
                <div *ngFor="let task of splitRelatedTasks(prop.value)" class="task-item">
                  {{ task }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Task Actions -->
        <div class="node-actions" *ngIf="selectedNodeDetails?.type === 'task'">
          <button 
            class="mark-completed-btn"
            [class.completed]="isTaskCompleted(selectedNodeDetails)"
            [disabled]="isTaskCompleted(selectedNodeDetails)"
            (click)="markTaskAsCompleted(selectedNodeDetails)">
            <span class="btn-icon">{{ isTaskCompleted(selectedNodeDetails) ? '✓' : '⏳' }}</span>
            <span>{{ isTaskCompleted(selectedNodeDetails) ? 'Task Completed' : 'Mark as Completed' }}</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
